# 变更日志

## [2024-12-19] - 模块化重构

### 🏗️ 架构重构
- **模块化拆分**: 将原有的 `script.js` 按功能拆分为8个独立模块
- **代码组织优化**: 每个模块不超过200行，提高可维护性
- **依赖管理**: 清晰的模块依赖关系和加载顺序

### 📦 新增模块
- **`utils.js`** (工具函数模块): toast通知、JSON解析等通用功能
- **`data-manager.js`** (数据管理模块): 数据保存、导出、导入、自动保存
- **`api-config.js`** (API配置管理模块): API设置、测试、模型管理
- **`form-init.js`** (表单初始化模块): 字段ID管理、描述符生成
- **`text-capture.js`** (文字采集核心模块): 弹窗管理、状态控制
- **`ai-analysis.js`** (AI分析模块): 模型调用、结果分析、应用
- **`main.js`** (主初始化模块): 事件绑定、模块协调

### 🔧 技术改进
- **模块化架构**: 使用 `window` 对象进行模块间通信
- **加载顺序优化**: 确保依赖模块先加载
- **代码分离**: 功能职责清晰，便于维护和扩展
- **文件大小控制**: 每个模块控制在200行以内

### 📋 文件结构
```
citespace/
├── config.js           # API配置文件
├── utils.js            # 工具函数模块
├── data-manager.js     # 数据管理模块
├── api-config.js       # API配置管理模块
├── form-init.js        # 表单初始化模块
├── text-capture.js     # 文字采集核心模块
├── ai-analysis.js      # AI分析模块
├── main.js             # 主初始化模块
└── [其他文件...]
```

### 🎯 优势
- **可维护性**: 代码结构清晰，便于定位和修改
- **可扩展性**: 新功能可以独立模块形式添加
- **可读性**: 每个模块职责单一，代码更易理解
- **协作性**: 多人开发时可以并行处理不同模块

---

## [2024-12-19] - 增强JSON解析和清理代码

### 🆕 新增功能
- **增强JSON解析**: 大幅提升AI返回数据的解析能力，支持多种格式修复
- **详细错误调试**: 添加原始AI返回内容查看功能，便于排查问题
- **代码清理**: 移除大量调试日志，提升代码整洁度

### 🔧 技术改进
- **parseJsonFromAi函数增强**:
  - 添加JSON格式自动修复（单引号→双引号、无引号键名、多余逗号等）
  - 支持正则匹配提取JSON片段
  - 增强控制字符清理
- **错误处理优化**:
  - 添加"查看AI原始返回内容"按钮
  - 存储原始AI响应到全局变量便于调试
  - 改进错误信息显示格式

### 🧹 代码清理
- **移除调试日志**: 删除大量console.log语句，保留关键错误日志
- **删除无用文件**: 移除test-config.html等测试文件
- **文档更新**: 更新README和SETUP文档，移除对已删除文件的引用

### 🐛 问题修复
- **JSON解析错误**: 修复"无法解析API返回的数据格式"问题
- **代码格式**: 修复部分代码缩进和格式问题

---

## [2024-12-19] - 自动API连接测试

### 🆕 新增功能
- **自动连接测试**: 选择模型后自动进行API连接测试
- **即时反馈**: 显示连接成功或失败的消息提示

### 🔧 技术改进
- **testApiConnection函数增强**:
  - 支持静默模式（silent参数）
  - 返回布尔值表示连接状态
  - 改进错误处理和状态显示
- **事件绑定优化**:
  - 提供商切换时自动测试连接
  - 模型选择时自动测试连接
  - 提供用户友好的反馈信息

### 🎯 用户体验
- **即时验证**: 用户选择配置后立即知道是否可用
- **清晰反馈**: 成功/失败状态明确显示
- **减少手动测试**: 无需手动点击测试按钮

---

## [2024-12-19] - 增强JSON解析能力

### 🆕 新增功能
- **详细解析日志**: 添加完整的JSON解析过程日志
- **多级解析策略**: 实现6种不同的JSON解析方法

### 🔧 技术改进
- **parseJsonFromAi函数重构**:
  - 添加详细的控制台日志输出
  - 实现6种解析策略：直接解析、片段截取、栈解析、格式修复、正则匹配
  - 每种方法都有详细的成功/失败日志
- **错误信息增强**: 提供更详细的解析失败原因

### 🐛 问题修复
- **JSON解析错误**: 针对"Expected ',' or '}' after property value"等错误进行优化
- **调试能力**: 大幅提升问题排查能力

---

## [2024-12-19] - 优化弹窗样式和字段识别

### 🎨 界面优化
- **弹窗尺寸**: 增大弹窗尺寸，避免滚动条，完整显示内容
- **识别结果预览**: 重新设计样式，使用现代化渐变和阴影效果
- **视觉层次**: 改进颜色搭配和布局结构

### 🔧 技术改进
- **字段识别增强**: 
  - 收集更多字段属性（placeholder、name、idAttr、classes）
  - 改进AI提示词，支持模糊匹配和同义词识别
  - 增强字段映射的准确性
- **样式系统**: 使用CSS变量和现代设计模式

### 📊 用户体验
- **更大显示区域**: 弹窗宽度95%，最大宽度1200px
- **更好视觉效果**: 蓝色渐变主题，圆角设计，阴影效果
- **更清晰信息**: 改进状态显示和结果展示

---

## [2024-12-19] - 默认模型设置和配置优化

### 🔧 配置优化
- **默认模型**: 设置豆包Flash模型为默认选择
- **配置管理**: 改进API配置的保存和加载机制
- **模型选择**: 优化模型下拉列表的初始化逻辑

### 🎯 用户体验
- **开箱即用**: 新用户无需手动选择模型
- **智能默认**: 根据提供商自动选择最佳模型
- **配置持久化**: 用户选择自动保存到本地存储

---

## [2024-12-19] - 移除采集文字显示和增强字段识别

### 🆕 功能调整
- **移除采集文字显示**: 不再在弹窗中显示"采集到的文字"预览
- **增强字段识别**: 改进AI模型的字段识别能力

### 🔧 技术改进
- **字段描述增强**: 
  - 收集更多字段属性（placeholder、name、idAttr、classes）
  - 提供更丰富的上下文信息给AI
- **AI提示词优化**: 
  - 支持基于多种属性的模糊匹配
  - 增加同义词和上下文识别
  - 明确要求输出格式和字段映射

### 📊 识别能力
- **更准确匹配**: 基于多个属性进行字段匹配
- **更全面覆盖**: 识别更多可能的字段映射
- **更智能映射**: 支持同义词和上下文理解

---

## [2024-12-19] - 初始版本：文字采集和应用功能

### 🆕 核心功能
- **文字采集弹窗**: 实现完整的文字和图片采集界面
- **AI分析**: 集成多种AI模型进行智能数据提取
- **结果应用**: 一键将识别结果应用到表单字段
- **数据管理**: 支持数据保存、导出和导入

### 🔧 技术特性
- **多模型支持**: 豆包、DeepSeek、OpenAI
- **图片处理**: 支持图片上传和Base64转换
- **JSON解析**: 健壮的AI返回数据解析
- **表单映射**: 智能字段匹配和数据填充

### 📊 用户界面
- **现代化设计**: 渐变背景、圆角、阴影效果
- **响应式布局**: 适配不同屏幕尺寸
- **状态反馈**: 实时显示处理进度和结果
- **错误处理**: 友好的错误提示和重试机制

### 🎯 应用场景
- **学术研究**: CiteSpace文献分析数据采集
- **数据整理**: 表格和图表信息提取
- **表单填充**: 自动化数据录入
