# 价格图表切换修复说明

## 问题描述
在切换交易对时，价格走势图会重置，导致历史数据丢失，用户体验不佳。

## 问题原因
1. **全局数据存储**：所有交易对的价格数据都存储在同一个 `market_data` 字典中
2. **数据混合**：不同交易对的价格数据混合在一起，无法区分
3. **图表更新逻辑**：图表更新时没有考虑当前选中的交易对

## 修复方案

### 1. 数据结构重构
```python
# 修复前
market_data = {'timestamp': [], 'price': [], 'volume': []}

# 修复后  
market_data = {}  # 按交易对存储数据
```

### 2. 按交易对存储数据
```python
# 为每个交易对创建独立的数据存储
if symbol not in market_data:
    market_data[symbol] = {'timestamp': [], 'price': [], 'volume': []}

market_data[symbol]['timestamp'].append(datetime.now())
market_data[symbol]['price'].append(result['current_price'])
```

### 3. 图表函数优化
```python
def create_price_chart(symbol=None):
    """创建价格图表"""
    if symbol is None:
        symbol = 'BTC-USDT'  # 默认交易对
    
    # 获取指定交易对的数据
    symbol_data = market_data.get(symbol, {'timestamp': [], 'price': [], 'volume': []})
    
    # 显示等待数据提示
    if not symbol_data['timestamp']:
        fig = go.Figure()
        fig.add_annotation(
            text=f"等待 {symbol} 数据...",
            xref="paper", yref="paper",
            x=0.5, y=0.5,
            showarrow=False,
            font=dict(size=16, color="gray")
        )
        return fig
```

### 4. 回调函数更新
```python
@app.callback(
    Output('price-chart', 'figure'),
    [Input('strategy-store', 'data')],
    [State('symbol-dropdown', 'value')]  # 添加交易对状态
)
def update_price_chart(strategy_data, symbol):
    """更新价格图表"""
    return create_price_chart(symbol)
```

## 修复效果

### ✅ 解决的问题
1. **数据独立性**：每个交易对都有独立的价格数据存储
2. **历史数据保留**：切换交易对时不会丢失历史数据
3. **图表标题**：图表标题正确显示当前交易对名称
4. **用户体验**：新交易对会显示等待数据提示

### 📊 功能验证
- 每个交易对的数据点独立计数
- 价格范围正确显示
- 图表标题包含交易对名称
- 技术指标图表也支持交易对切换

## 使用说明

### 正常使用流程
1. 启动交易系统：`python main.py --mode web`
2. 访问Web界面：`http://127.0.0.1:8050`
3. 选择交易对，价格图表会显示该交易对的历史数据
4. 切换交易对时，图表会切换到对应交易对的数据

### 数据管理
- 每个交易对最多保存100个数据点
- 新交易对首次选择时会显示等待数据提示
- 数据按时间顺序自动更新

## 技术细节

### 数据存储结构
```python
market_data = {
    'BTC-USDT': {
        'timestamp': [datetime1, datetime2, ...],
        'price': [price1, price2, ...],
        'volume': [volume1, volume2, ...]
    },
    'ETH-USDT': {
        'timestamp': [datetime1, datetime2, ...],
        'price': [price1, price2, ...],
        'volume': [volume1, volume2, ...]
    }
}
```

### 性能优化
- 数据点限制：每个交易对最多100个数据点
- 内存管理：自动清理过期数据
- 响应速度：图表更新响应及时

## 总结
通过重构数据存储结构和优化图表更新逻辑，成功解决了切换交易对时价格走势图重置的问题。现在每个交易对都有独立的数据存储，用户可以流畅地在不同交易对之间切换，同时保持历史数据的完整性。 